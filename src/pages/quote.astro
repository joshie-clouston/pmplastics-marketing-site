---
import BaseLayout from '../layouts/BaseLayout.astro';

export const prerender = true;

const serviceTypes = [
  'Custom Fabrication',
  'CNC Water Jet Cutting',
  'CNC Vacuum Forming',
  'CNC Router Cutting',
  'CNC Laser Cutting',
  'Plastic Thermo Forming',
  'Laser Engraving & Etching',
  'Cut-to-Size Material',
  'Reverse Engineering',
  'Other',
];
---
<BaseLayout
  title="Get a Quote"
  description="Request a free quote for custom plastic fabrication, CNC cutting, laser engraving, and more. P&M Plastics — Gold Coast."
>
  <section class="section bg-white">
    <div class="container mx-auto max-w-2xl">
      <a href="/" class="inline-flex items-center gap-1 text-sm font-medium text-primary hover:underline mb-8">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        Back to home
      </a>

      <div data-animate="fade-up">
        <h1 class="text-3xl sm:text-4xl font-800 tracking-tight mb-4">Get a Quote</h1>
        <p class="text-lg text-muted-foreground mb-8">
          Tell us about your project and we'll get back to you with a quote. No job too big or small.
        </p>
      </div>

      <form id="quote-form" class="space-y-6" data-animate="fade-up">
        <!-- Name -->
        <div>
          <label for="name" class="block text-sm font-600 mb-2">Name <span class="text-primary">*</span></label>
          <input
            type="text"
            id="name"
            name="name"
            required
            autofocus
            class="w-full px-4 py-3 rounded-lg border border-border bg-white text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
            placeholder="Your name"
          />
        </div>

        <!-- Email -->
        <div>
          <label for="email" class="block text-sm font-600 mb-2">Email <span class="text-primary">*</span></label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-4 py-3 rounded-lg border border-border bg-white text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
            placeholder="you@example.com"
          />
        </div>

        <!-- Phone -->
        <div>
          <label for="phone" class="block text-sm font-600 mb-2">Phone <span class="text-primary">*</span></label>
          <input
            type="tel"
            id="phone"
            name="phone"
            required
            class="w-full px-4 py-3 rounded-lg border border-border bg-white text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
            placeholder="04XX XXX XXX"
          />
        </div>

        <!-- Company -->
        <div>
          <label for="company" class="block text-sm font-600 mb-2">Company <span class="text-muted-foreground font-normal">(optional)</span></label>
          <input
            type="text"
            id="company"
            name="company"
            class="w-full px-4 py-3 rounded-lg border border-border bg-white text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
            placeholder="Your company name"
          />
        </div>

        <!-- Service type -->
        <div>
          <label for="service" class="block text-sm font-600 mb-2">What do you need? <span class="text-primary">*</span></label>
          <select
            id="service"
            name="service"
            required
            class="w-full px-4 py-3 rounded-lg border border-border bg-white text-foreground focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors"
          >
            <option value="">Select a service...</option>
            {serviceTypes.map((type) => (
              <option value={type}>{type}</option>
            ))}
          </select>
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="block text-sm font-600 mb-2">Project details <span class="text-primary">*</span></label>
          <textarea
            id="description"
            name="description"
            required
            rows={5}
            class="w-full px-4 py-3 rounded-lg border border-border bg-white text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors resize-y"
            placeholder="Describe what you need — materials, dimensions, quantities, anything that helps us understand your project."
          ></textarea>
        </div>

        <!-- Submit -->
        <button
          type="submit"
          id="submit-btn"
          class="btn btn-primary btn-lg w-full"
        >
          Send Quote Request
        </button>

        <!-- Status messages -->
        <div id="form-success" class="hidden p-4 rounded-lg bg-success/10 text-success text-center font-600">
          Quote request sent! We'll be in touch shortly.
        </div>
        <div id="form-error" class="hidden p-4 rounded-lg bg-destructive/10 text-destructive text-center font-600">
          Something went wrong. Please call us on <a href="tel:0755357544" class="underline">07 5535 7544</a>.
        </div>
      </form>
    </div>
  </section>
</BaseLayout>

<script>
  import { getUtmParams } from '../lib/utm';

  function initQuoteForm() {
    const form = document.getElementById('quote-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const successMsg = document.getElementById('form-success');
    const errorMsg = document.getElementById('form-error');

    if (!form) return;

    // Pre-select service from URL param
    const urlParams = new URLSearchParams(window.location.search);
    const preselect = urlParams.get('type');
    if (preselect) {
      const select = document.getElementById('service') as unknown as HTMLSelectElement;
      if (select) {
        for (const opt of select.options) {
          if (opt.value.toLowerCase().includes(preselect.toLowerCase())) {
            select.value = opt.value;
            break;
          }
        }
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';
      successMsg?.classList.add('hidden');
      errorMsg?.classList.add('hidden');

      try {
        const data = Object.fromEntries(new FormData(form));
        const response = await fetch('/api/quote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...data, ...getUtmParams() }),
        });

        if (!response.ok) throw new Error('Failed');

        form.reset();
        successMsg?.classList.remove('hidden');
        form.classList.add('hidden');
      } catch {
        errorMsg?.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Quote Request';
      }
    });
  }

  document.addEventListener('astro:page-load', initQuoteForm);
  initQuoteForm();
</script>
